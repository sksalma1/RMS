<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin - Manage Menu - RMS Pro</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Poppins', sans-serif;
    }

    body {
      line-height: 1.6;
      color: #333;
      background-color: #f9f9f9;
    }

    .navbar {
      background-color: #1a2a44;
      padding: 1rem 2rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
      position: fixed;
      width: 100%;
      top: 0;
      z-index: 1000;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
    }

    .navbar .logo {
      color: #fff;
      font-size: 1.6rem;
      font-weight: 600;
      letter-spacing: 1px;
    }

    .navbar .nav-links {
      list-style: none;
      display: flex;
      align-items: center;
    }

    .navbar .nav-links li {
      margin-left: 2rem;
    }

    .navbar .nav-links a {
      color: #fff;
      text-decoration: none;
      font-size: 0.9rem;
      font-weight: 400;
      text-transform: uppercase;
      transition: color 0.3s ease;
    }

    .navbar .nav-links a:hover {
      color: #ff6f61;
    }

    .search-container {
      display: flex;
      align-items: center;
    }

    .search-container input {
      padding: 0.5rem;
      border: none;
      border-radius: 5px 0 0 5px;
      font-size: 0.9rem;
      outline: none;
    }

    .search-container button {
      padding: 0.5rem 1rem;
      border: none;
      background-color: #ff6f61;
      color: #fff;
      border-radius: 0 5px 5px 0;
      cursor: pointer;
      font-size: 0.9rem;
      transition: background-color 0.3s ease;
    }

    .search-container button:hover {
      background-color: #e65b50;
    }

    .menu-container {
      max-width: 1200px;
      margin: 80px auto 0;
      padding: 2rem;
    }

    .restaurant-header {
      text-align: center;
      margin-bottom: 2rem;
    }

    .restaurant-header h1 {
      font-size: 2.5rem;
      font-weight: 600;
      color: #1a2a44;
    }

    .form-container {
      max-width: 800px;
      margin: 20px auto;
      padding: 20px;
      background: #fff;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
    }

    .form-container input,
    .form-container button {
      width: 100%;
      margin: 10px 0;
      padding: 10px;
      border-radius: 5px;
      border: 1px solid #ccc;
    }

    .form-container button {
      background-color: #ff6f61;
      color: #fff;
      border: none;
      cursor: pointer;
    }

    .form-container button:hover {
      background-color: #e65b50;
    }

    .category-section {
      margin-bottom: 2rem;
    }

    .category-section.hidden {
      display: none;
    }

    .category-section h2 {
      font-size: 1.8rem;
      color: #1a2a44;
      margin-bottom: 1rem;
      border-bottom: 2px solid #ff6f61;
      padding-bottom: 0.5rem;
    }

    .menu-items {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 1.5rem;
      justify-content: center;
    }

    .menu-item {
      background-color: #fff;
      border-radius: 10px;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.05);
      padding: 1rem;
      width: 80%;
      text-align: center;
      transition: transform 0.3s ease;
      cursor: pointer;
    }

    .menu-item:hover {
      transform: translateY(-5px);
    }

    .menu-item.hidden {
      display: none;
    }

    .menu-item img {
      width: 100px;
      height: 100px;
      object-fit: cover;
      border-radius: 8px;
      margin: 0 auto 10px;
    }

    .item-details h3 {
      font-size: 1.2rem;
      font-weight: 600;
      color: #333;
      margin-bottom: 0.5rem;
    }

    .price, .quantity {
      font-size: 1rem;
      font-weight: 600;
      margin-bottom: 10px;
    }

    .price {
      color: #ff6f61;
    }

    .quantity {
      color: #2c6e49;
    }

    .menu-item button {
      background-color: #ff6f61;
      color: #fff;
      padding: 0.5rem 1rem;
      border: none;
      border-radius: 5px;
      font-size: 0.9rem;
      font-weight: 600;
      cursor: pointer;
      transition: background-color 0.3s ease;
      margin: 5px;
    }

    .menu-item button:hover {
      background-color: #e65b50;
    }

    .update-form {
      display: none;
      margin-top: 10px;
    }

    .update-form input {
      margin: 5px 0;
    }

    .update-form button {
      margin-top: 5px;
    }

    footer {
      background-color: #1a2a44;
      color: #fff;
      text-align: center;
      padding: 2rem;
      font-size: 0.9rem;
      font-weight: 300;
      margin-top: 3rem;
    }

    footer a {
      color: #ff6f61;
      text-decoration: none;
      margin: 0 10px;
      transition: color 0.3s ease;
    }

    footer a:hover {
      color: #e65b50;
    }

    @media (max-width: 768px) {
      .navbar {
        padding: 1rem;
      }

      .navbar .nav-links li {
        margin-left: 1rem;
      }

      .search-container input {
        width: 120px;
      }

      .menu-items {
        grid-template-columns: repeat(2, 1fr);
      }
    }

    @media (max-width: 480px) {
      .navbar {
        flex-direction: column;
        padding: 1rem;
      }

      .navbar .nav-links {
        flex-direction: column;
        width: 100%;
        text-align: center;
      }

      .navbar .nav-links li {
        margin: 0.5rem 0;
      }

      .search-container {
        margin-top: 1rem;
        width: 100%;
        justify-content: center;
      }

      .search-container input {
        width: 70%;
      }

      .menu-items {
        grid-template-columns: 1fr;
      }

      .menu-item {
        width: 100%;
      }

      .restaurant-header h1 {
        font-size: 2rem;
      }
    }
  </style>
</head>
<body>
  <nav class="navbar">
    <div class="logo">RMS Admin</div>
    <div class="search-container">
      <input type="text" id="searchInput" placeholder="Search menu items or categories...">
      <button onclick="filterMenu()">Search</button>
    </div>
    <ul class="nav-links">
      <li><a href="admin_home.html">HOME</a></li>
      <li><a href="admin_tables.html">TABLES</a></li>
      <li><a href="admin_events.html">EVENT HALLS</a></li>
      <li><a href="admin_offers.html">OFFERS</a></li>
      <li><a href="inventory.html">INVENTORY</a></li>
      <li><a href="#" onclick="logout()">LOGOUT</a></li>
    </ul>
  </nav>

  <div class="menu-container">
    <div class="restaurant-header">
      <h1>Manage Menu</h1>
    </div>

    <div class="form-container">
      <h2>Add New Menu Item</h2>
      <input type="text" id="name" placeholder="Item Name">
      <input type="text" id="category" placeholder="Category">
      <input type="number" id="price" placeholder="Price" step="0.01">
      <input type="number" id="quantity" placeholder="Quantity" min="0" required>
      <input type="text" id="image" placeholder="Image URL">
      <button onclick="addMenuItem()">Add Item</button>
    </div>

    <div id="menu-list"></div>
  </div>

  <footer>
    <p>Â© 2025 Restaurant Management System. All rights reserved. | <a href="#">Privacy Policy</a> | <a href="#">Terms of Service</a></p>
  </footer>

  <script>
    const email = localStorage.getItem("adminEmail");
    if (!email) {
      alert("Access denied. Admin email is required. Please log in.");
      window.location.href = "admin_login.html";
    } else {
      console.log("Logged in with email:", email);
    }

    let allMenuItems = [];

    async function fetchMenu() {
      const menuContainer = document.getElementById("menu-list");
      try {
        const res = await fetch(`http://localhost:5001/admin/menu?email=${encodeURIComponent(email)}`);
        if (!res.ok) throw new Error(`Failed to fetch menu: ${res.statusText}`);
        const menuItems = await res.json();
        allMenuItems = menuItems;

        const groupedItems = menuItems.reduce((acc, item) => {
          const category = item.category || "Uncategorized";
          if (!acc[category]) acc[category] = [];
          acc[category].push(item);
          return acc;
        }, {});

        menuContainer.innerHTML = "";

        Object.keys(groupedItems).forEach(category => {
          const categorySection = document.createElement("div");
          categorySection.classList.add("category-section");
          categorySection.dataset.category = category.toLowerCase();

          const categoryTitle = document.createElement("h2");
          categoryTitle.textContent = category;
          categorySection.appendChild(categoryTitle);

          const itemsContainer = document.createElement("div");
          itemsContainer.classList.add("menu-items");

          groupedItems[category].forEach(item => {
            const menuItemDiv = document.createElement("div");
            menuItemDiv.classList.add("menu-item");
            menuItemDiv.dataset.name = item.name.toLowerCase();
            menuItemDiv.dataset.category = category.toLowerCase();
            menuItemDiv.dataset.id = item._id;

            const itemPriceStr = item.price ? item.price.replace(/[^0-9.]/g, '') : '0';
            const itemPrice = parseFloat(itemPriceStr) || 0;
            const itemQuantity = item.quantity !== undefined ? item.quantity : 0;
            menuItemDiv.innerHTML = `
              <img src="${item.image || 'fallback.jpg'}" alt="${item.name}" onerror="this.src='fallback.jpg';" />
              <div class="item-details">
                <h3>${item.name}</h3>
                <p class="price">Price: â¹${itemPrice.toFixed(2)}</p>
                <p class="quantity">Quantity: ${itemQuantity}</p>
                <button onclick="showUpdateForm('${item._id}', '${item.name}', '${item.category}', '${item.price}', '${item.image || ''}')">Update</button>
                <button onclick="deleteMenuItem('${item._id}')">Delete</button>
              </div>
              <div id="update-form-${item._id}" class="update-form">
                <input type="text" id="update-name-${item._id}" placeholder="New Name (optional)" value="${item.name}">
                <input type="text" id="update-category-${item._id}" placeholder="New Category (optional)" value="${item.category || ''}">
                <input type="number" id="update-price-${item._id}" placeholder="New Price (optional)" step="0.01" value="${itemPriceStr}">
                <input type="text" id="update-image-${item._id}" placeholder="New Image URL" value="${item.image || ''}">
                <button onclick="updateMenuItem('${item._id}')">Save Changes</button>
                <button onclick="hideUpdateForm('${item._id}')">Cancel</button>
              </div>
            `;

            itemsContainer.appendChild(menuItemDiv);
          });

          categorySection.appendChild(itemsContainer);
          menuContainer.appendChild(categorySection);
        });

        // Add click event listeners to menu items
        document.querySelectorAll(".menu-item").forEach(item => {
          item.addEventListener("click", function(e) {
            // Prevent click on buttons from triggering item filter
            if (e.target.tagName === "BUTTON" || e.target.closest(".update-form")) return;
            filterByItem(this.dataset.id, this.dataset.category);
          });
        });
      } catch (error) {
        console.error("Error fetching menu:", error);
        menuContainer.innerHTML = "<p>Failed to load menu. Please try again later.</p>";
      }
    }

    async function addMenuItem() {
      const name = document.getElementById("name").value;
      const category = document.getElementById("category").value;
      const price = document.getElementById("price").value;
      const quantity = document.getElementById("quantity").value;
      const image = document.getElementById("image").value;

      if (!name || !category || !price || !quantity) {
        alert("Please fill in name, category, price, and quantity.");
        return;
      }

      const res = await fetch("http://localhost:5001/admin/menu/add", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ email, name, category, price, quantity, image })
      });

      const data = await res.json();
      alert(data.message);
      if (res.ok) {
        document.getElementById("name").value = "";
        document.getElementById("category").value = "";
        document.getElementById("price").value = "";
        document.getElementById("quantity").value = "";
        document.getElementById("image").value = "";
        fetchMenu();
      }
    }

    function showUpdateForm(id, name, category, price, image) {
      const form = document.getElementById(`update-form-${id}`);
      form.style.display = "block";
    }

    function hideUpdateForm(id) {
      const form = document.getElementById(`update-form-${id}`);
      form.style.display = "none";
    }

    async function updateMenuItem(id) {
      const name = document.getElementById(`update-name-${id}`).value.trim() || null;
      const category = document.getElementById(`update-category-${id}`).value.trim() || null;
      const price = document.getElementById(`update-price-${id}`).value.trim() || null;
      const image = document.getElementById(`update-image-${id}`).value.trim() || null;

      const res = await fetch(`http://localhost:5001/admin/menu/update/${id}`, {
        method: "PUT",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ email, name, category, price, image })
      });

      const data = await res.json();
      alert(data.message || "Update failed.");
      if (res.ok) {
        hideUpdateForm(id);
        fetchMenu();
      }
    }

    async function deleteMenuItem(id) {
      if (confirm("Are you sure you want to delete this item?")) {
        const res = await fetch(`http://localhost:5001/admin/menu/delete/${id}`, {
          method: "DELETE",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ email })
        });

        const data = await res.json();
        alert(data.message);
        fetchMenu();
      }
    }

    function filterMenu() {
      const searchTerm = document.getElementById("searchInput").value.trim().toLowerCase();
      const categorySections = document.querySelectorAll(".category-section");
      const menuItems = document.querySelectorAll(".menu-item");

      if (!searchTerm) {
        // Show all categories and items when search is cleared
        categorySections.forEach(section => {
          section.classList.remove("hidden");
        });
        menuItems.forEach(item => {
          item.classList.remove("hidden");
        });
        return;
      }

      let foundCategory = false;
      let foundItem = false;

      // Check if search term matches a category
      categorySections.forEach(section => {
        const category = section.dataset.category;
        if (category.includes(searchTerm)) {
          section.classList.remove("hidden");
          section.querySelectorAll(".menu-item").forEach(item => {
            item.classList.remove("hidden");
          });
          foundCategory = true;
        } else {
          section.classList.add("hidden");
        }
      });

      // If no category match, check for item matches
      if (!foundCategory) {
        categorySections.forEach(section => {
          const items = section.querySelectorAll(".menu-item");
          let hasVisibleItem = false;
          items.forEach(item => {
            const itemName = item.dataset.name;
            if (itemName.includes(searchTerm)) {
              item.classList.remove("hidden");
              hasVisibleItem = true;
              foundItem = true;
            } else {
              item.classList.add("hidden");
            }
          });
          section.classList.toggle("hidden", !hasVisibleItem);
        });
      }

      // If no matches found, show all categories with no items
      if (!foundCategory && !foundItem) {
        categorySections.forEach(section => {
          section.classList.remove("hidden");
          section.querySelectorAll(".menu-item").forEach(item => {
            item.classList.add("hidden");
          });
        });
      }
    }

    function filterByItem(itemId, itemCategory) {
      const categorySections = document.querySelectorAll(".category-section");
      const menuItems = document.querySelectorAll(".menu-item");

      categorySections.forEach(section => {
        const category = section.dataset.category;
        if (category === itemCategory) {
          section.classList.remove("hidden");
          section.querySelectorAll(".menu-item").forEach(item => {
            if (item.dataset.id === itemId) {
              item.classList.remove("hidden");
            } else {
              item.classList.add("hidden");
            }
          });
        } else {
          section.classList.add("hidden");
        }
      });
    }

    function logout() {
      localStorage.clear();
      window.location.href = "admin_login.html";
    }

    document.addEventListener("DOMContentLoaded", () => {
      fetchMenu();
      // Add Enter key listener for search
      document.getElementById("searchInput").addEventListener("keypress", function(e) {
        if (e.key === "Enter") {
          filterMenu();
        }
      });
      // Add input event listener to reset menu when search is cleared
      document.getElementById("searchInput").addEventListener("input", filterMenu);
    });
  </script>
</body>
</html>